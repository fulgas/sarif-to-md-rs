name: Publish

on:
  release:
    types: [ published ]

permissions:
  contents: write

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Verify version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep '^version = ' crates/sarif-to-md/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ "$CARGO_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "âŒ Version mismatch!"
            echo "Tag version: ${{ steps.version.outputs.version }}"
            echo "Cargo.toml version: $CARGO_VERSION"
            exit 1
          fi
          echo "âœ… Version matches: $CARGO_VERSION"

      - name: Check if pre-release
        id: prerelease
        run: |
          if [[ "${{ steps.version.outputs.version }}" =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Pre-release detected"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Stable release"
          fi

      - name: Publish sarif-to-md-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/sarif-to-md-core
          if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "true" ]; then
            echo "Publishing pre-release with --allow-dirty"
            #cargo publish --token "$CARGO_REGISTRY_TOKEN" --allow-dirty
          else
            #cargo publish --token "$CARGO_REGISTRY_TOKEN"
          fi

      - name: Publish sarif-to-md
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/sarif-to-md
          if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "true" ]; then
            echo "Publishing pre-release with --allow-dirty"
            #cargo publish --token "$CARGO_REGISTRY_TOKEN" --allow-dirty
          else
            #cargo publish --token "$CARGO_REGISTRY_TOKEN"
          fi

      - name: Publish complete
        run: |
          echo "âœ… Published to crates.io!"
          echo "ðŸ“¦ sarif-to-md-core@${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ sarif-to-md@${{ steps.version.outputs.version }}"

          # Add to job summary
          echo "## ðŸ“¦ Published to crates.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully published version \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Crates Published:" >> $GITHUB_STEP_SUMMARY
          echo "- [\`sarif-to-md-core@${{ steps.version.outputs.version }}\`](https://crates.io/crates/sarif-to-md-core)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`sarif-to-md@${{ steps.version.outputs.version }}\`](https://crates.io/crates/sarif-to-md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "true" ]; then
            echo "ðŸš¨ **Pre-release version**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Stable release**" >> $GITHUB_STEP_SUMMARY
          fi